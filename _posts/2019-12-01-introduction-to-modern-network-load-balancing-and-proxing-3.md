---
layout: post
title: 최신 네트워크 로드 밸런싱 및 프록시 3 - L4 로드밸런싱 최신 기술 Introduction to modern network load balancing and proxing #2 - Current state of the art in L4 load balancing
tags: [번역, 로드밸런서, 토폴로지]
---

[Introduction to modern network load balancing and proxing](https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236)

## L4로드 밸런싱의 최신 기술
### L4로드 밸런서는 여전히 사용할 만 한가?
이 포스트는 L7로드 밸런서가 최신 프로토콜에 얼마나 적합한 지에 대해 이미 얘기했고 아래에서 L7로드 밸런서 기능으로 넘어간다. 이것은 L4로드 밸런서가 더 이상 사용할 필요가 없다는 걸까? 아니다. L7로드 밸런서는 L2로드 밸런서를 서비스 간 통신을 위해 완전히 대체 할 것이지만 L4로드 밸런서는 거의 모든 최신 대형 분산 아키텍처가 2 계층 L4 / L7로드 밸런싱 아키텍처를 사용하기 때문에 여전히 엣지에서 매우 연관성이 높다. 인터넷 트래픽. 에지 구축에서 L7로드 밸런서보다 전용 L4로드 밸런서를 배치하면 다음과 같은 이점이 있다.

* L7로드 밸런서는 애플리케이션 트래픽의 훨씬 더 정교한 분석, 변환 및 라우팅을 수행하므로 최적화 된 L4로드 밸런서보다 상대적으로 적은 비율의 원시 트래픽로드 (초당 패킷 수 및 초당 바이트 수)를 처리 할 수 ​​있다. 이 사실은 일반적으로 L4로드 밸런서를 특정 유형의 DoS 공격 (예 : SYN 플러드, 일반 패킷 플러드 공격 등)을 처리하기에 더 좋은 위치로 만든다.
* L7로드 밸런서는 L4로드 밸런서보다 더 적극적으로 개발되고 더 자주 배포되며 더 많은 버그가 있다. L7로드 밸런서 배포 중에 상태 확인 및 배수를 수행 할 수있는 L4로드 밸런서를 앞에 배치하는 것은 일반적으로 BGP 및 ECMP를 사용하는 최신 L4로드 밸런서에 사용되는 배포 메커니즘보다 훨씬 쉽다 (아래에 자세히 설명되어 있음). 마지막으로 L7로드 밸런서는 기능의 복잡성으로 인해 버그가 발생할 가능성이 높기 때문에 L4로드 밸런서가 장애 및 이상을 처리 할 수 ​​있으면 전체 시스템의 안정성이 향상된다.

다음 섹션에서는 미들 / 에지 프록시 L4로드 밸런서를위한 여러 가지 다른 디자인을 설명한다. 다음 디자인은 일반적인 경우에는 클라이언트 라이브러리 및 사이드카 프록시 토폴로지에 적용 할 수 없다.

### TCP/UDP 종료 로드 밸런서(TCP/UDP Termination load balancers)

![Figure 8](/images/posts/figure8-l4-termination-load-balancer.png)

여전히 사용중인 L4로드 밸런서의 첫 번째 유형은 그림 8에 나와있는 종료 로드 밸런서이다. 이는 위의 L4로드 밸런싱 소개에서 본 것과 동일한 로드 밸런서다. 이 유형의 로드 밸런서는 두 개의 개별 TCP 연결을 사용한다. 하나는 클라이언트와로드 밸런서 사이, 하나는로드 밸런서와 백엔드 사이이다.

L4 종료 로드 밸런서는 두 가지 이유로 사용한다.

1. 구현하기가 비교적 간단하다.
2. 클라이언트와의 근접성 (낮은 대기 시간)으로 연결이 종료되면 성능에 상당한 영향을 미친다. 특히, 종료 로드 밸런서를 손실이있는 네트워크 (예 : 셀룰러)를 사용하는 클라이언트에 가까이 배치 할 수 있으면 데이터가 최종 위치로 이동하는 동안 안정적인 광섬유 전송으로 이동하기 전에 재전송이 더 빨리 발생할 수 있다. 다른 방법으로,이 유형의 로드 밸런서는 원시 TCP 연결 종료를 위한 POP (Point of Presence) 시나리오에서 사용될 수 있다.

### TCP/UDP 패스 스루 로드 밸런서(TCP/UDP passthrough load balancer)

![Figure 9](/images/posts/figure9-l4-passthrough-load-balancer.png)

L4로드 밸런서의 두 번째 유형은 그림 9에 표시된 패스 스루 로드 밸런서 이다. 이 유형의로드 밸런서에서 TCP 연결은로드 밸런서에 의해 종료되지 않는다. 대신, 연결 추적 및 NAT (Network Address Translation)가 수행 된 후 각 연결의 패킷이 선택된 백엔드로 전달된다. 먼저 연결 추적 및 NAT를 정의한다.

* 연결 추적 : 모든 활성 TCP 연결의 상태를 추적하는 프로세스다. 여기에는 핸드 셰이크 완료 여부, FIN 수신 여부, 연결 유휴 시간, 연결에 선택된 백엔드 등과 같은 데이터가 포함된다.
* NAT : NAT는 연결 추적 데이터를 사용하여 패킷이로드 밸런서를 통과 할 때 패킷의 IP / 포트 정보를 변경하는 프로세스다.

연결 추적과 NAT를 모두 사용하여 로드 밸런서는 클라이언트에서 백엔드로 대부분의 원시 TCP 트래픽을 통과 할 수 있습니다. 예를 들어 클라이언트가 1.2.3.4:80과 대화하고 선택한 백엔드가 10.0.0.2:9000에 있다고 가정합니다. 클라이언트 TCP 패킷은 1.2.3.4:80에로드 밸런서에 도착합니다. 그런 다음로드 밸런서는 패킷의 대상 IP 및 포트를 10.0.0.2:9000으로 교체합니다. 또한 패킷의 소스 IP를로드 밸런서의 IP 주소와 교체합니다. 따라서 백엔드가 TCP 연결에서 응답하면 패킷이로드 밸런서로 돌아가 연결 추적이 발생하고 NAT가 다시 역방향으로 발생할 수 있습니다.

이전 섹션에서 설명한 종료 로드 밸런서 대신 이 유형의 로드 밸런서가 더 복잡한 이유는 다음과 같다.

* 성능 및 리소스 사용량 : 패스스루 로드 밸런서는 TCP 연결을 종료하지 않으므로 TCP 연결 창을 버퍼링 할 필요가 없디. 연결 당 저장된 상태의 양은 매우 작으며 일반적으로 효율적인 해시 테이블 조회를 통해 접근한다. 이로 인해 패스스루 밸런서는 일반적으로 종료 로드 밸런서보다 실질적으로 더 많은 수의 활성 연결 및 초당 패킷 (PPS)을 처리 할 수 ​​있다.
* 백엔드에서 사용자 지정 혼잡 제어를 수행 할 수 있다. TCP 혼잡 제어는 인터넷의 엔드 포인트가 사용 가능한 대역폭과 버퍼를 압도하지 않도록 데이터를 전송하는 매커니즘이다. 패스스루 로드 밸런서는 TCP 연결을 종료하지 않기 때문에 정체 제어에 참여하지 않는다. 이 사실은 백엔드가 애플리케이션 사용 사례에 따라 다른 혼잡 제어 알고리즘을 사용할 수 있도록 한다. 또한 혼잡 제어 변경 (예 : 최근 BBR 롤아웃)을보다 쉽게 ​​실험 할 수 있다.
* DSR (Direct Server Return) 및 클러스터 된 L4로드 밸런싱의 기준을 형성한다. DSR 및 분산 된 일관된 해싱 (클러스터링)과 같은 고급 L4로드 밸런싱 기술 (다음 섹션에서 설명)에는 통과로드 밸런싱이 필요하다.

### DSR(Direct Server Return)

![Figure 10](/images/posts/figure10-l4-direct-server-return.png)

DSR은 이전 섹션에서 설명한 패스 스루 로드 밸런서 기반이다. DSR은 수신 / 요청 패킷만 로드 밸런서를 통과하도록 되어있다. 송신 / 응답 패킷은 로드 밸런서를 중심으로 클라이언트로 직접 이동한다. DSR을 수행하는 것이 흥미로운 이유는 많은 워크로드에서 응답 트래픽 왜소가 트래픽을 요청하기 때문입니다 (예 : 일반적인 HTTP 요청 / 응답 패턴). 트래픽의 10 %가 요청 트래픽이고 트래픽의 90 %가 응답 트래픽이라고 가정하면 DSR을 사용하는 경우 용량의 1/10 인로드 밸런서가 시스템 요구를 충족시킬 수 있다. 로드 밸런서는 매우 비싸기 때문에 이러한 유형의 최적화는 시스템 비용과 안정성에 상당한 영향을 줄 수 있다. DSR로드 밸런서는 다음과 같이 패스 스루로드 밸런서의 개념을 확장한다.

* 로드 밸런서는 여전히 일반적으로 부분 연결 추적을 수행한다. 응답 패킷은 로드 밸런서를 통과하지 않으므로로드 밸런서는 전체 TCP 연결 상태를 인식하지 못한다. 그러나 로드 밸런서는 클라이언트 패킷을보고 다양한 유형의 유휴 시간 초과를 사용하여 상태를 강력하게 유추 할 수 있다.
* NAT 대신 로드 밸런서는 일반적으로 GRE (Generic Routing Encapsulation)를 사용하여로드 밸런서에서 백엔드로 전송되는 IP 패킷을 캡슐화한다. 따라서 백엔드가 캡슐화 된 패킷을 수신하면 패킷을 캡슐화 해제하고 클라이언트의 원래 IP 주소와 TCP 포트를 알 수 있다. 이를 통해 로드 밸런서를 통해 응답 패킷이 흐르지 않고 백엔드가 클라이언트에 직접 응답 할 수 있다.
* DSR 로드 밸런서의 중요한 부분은 백엔드가 로드 밸런싱에 참여한다는 것이다. 백엔드는 올바르게 구성된 GRE 터널을 가져야하며 네트워크 설정의 하위 레벨 세부 사항에 따라 자체 연결 추적, NAT 등이 필요할 수 있다.
패스 스루로드 밸런서 및 DSR로드 밸런서 설계에는 로드 밸런서 및 백엔드 전체 연결 추적, NAT, GRE 등을 설정할 수있는 다양한 방법이 있지만 여기서는 다루지 않는다.

### 고 가용성 쌍을 통한 내결함성(Fault tolerance via high availability pairs)

![Figure 11](/images/posts/figure11-l4-fault-tolerance-via-ha-pairs-and-connection-tracking.png)

지금까지 L4로드 밸런서의 설계. 패스 스루 로드 밸런서와 DSR로드 밸런서 둘다 로드 밸런서 자체에 어느 정도의 연결 추적 및 상태가 필요하다. 로드 밸런서가 죽으면 어떻게 될까? 로드 밸런서의 단일 인스턴스가 죽으면 로드 밸런서를 통과하는 모든 연결이 끊기고, 응용 프로그램에 따라 응용 프로그램 성능에 상당한 영향을 줄 수 있다.

역사적으로 L4로드 밸런서는 Cisco, Juniper, F5 등에서 구매 한 하드웨어 장치였다. 이 장치는 매우 비싸고 많은 양의 트래픽을 처리했다. 모든 연결을 끊고 실질적인 애플리케이션 중단을 초래하는 단일로드 밸런서 장애를 방지하기 위해 로드 밸런서는 일반적으로 그림 11과 같이 고 가용성 쌍으로 배치됐다. 일반적인 HA로드 밸런서 설정은 다음과 같이 설계되었습니다.

* 한 쌍의 HA 에지 라우터는 몇 가지 가상 IP (VIP)를 서비스한다. 이 에지 라우터는 BGP (Border Gateway Protocol)를 사용하여 VIP를 발표한다. 기본 에지 라우터는 백업보다 BGP 가중치가 높으므로 정상 상태에서는 모든 트래픽을 처리한다. (BGP는 매우 복잡한 프로토콜입니다. 이 기사의 목적 상, BGP는 네트워크 장치가 다른 네트워크 장치로부터 트래픽을 가져올 수 있고 각 링크가 링크 트래픽을 우선 순위로하는 가중치를 가질 수 있음을 알리는 메커니즘을 고려하면 된다.) 
* 비슷하게, 기본 L4로드 밸런서는 백업보다 BGP 가중치가 높은 에지 라우터에 자신을 알리므로 정상 상태에서는 모든 트래픽을 처리한다.
* 기본 로드 밸런서는 백업에 교차 연결되며 모든 연결 추적 상태를 공유한다. 따라서 기본 서버가 종료되면 백업이 모든 활성 연결 처리를 대신 할 수 있다.
* 2 개의 에지 라우터와 2 개의로드 밸런서는 모두 상호 연결되어 있다. 즉, 에지 라우터 중 하나 또는 로드 밸런서 중 하나가 죽거나 다른 이유로 BGP 알림이 ​​철회 된 경우 백업이 모든 트래픽을 처리하는 것을 대신 할 수 있다.

오늘날에도 여전히 많은 트래픽이 발생하는 인터넷 응용 프로그램들이 서빙되는데 위와 같은 설정을 사용한다. 그러나 위의 접근 방식에는 실질적인 단점이 있다.

* 용량 사용을 고려하여 HA로드 밸런서 쌍에서 VIP를 올바르게 샤딩해야 한다. 단일 VIP가 단일 HA 쌍의 용량을 초과하는 경우 VIP를 여러 VIP로 분할해야한다.
* 시스템의 리소스 사용량이 부족하다. 용량의 50 %가 정상 상태에서 유휴 상태다. 보통 하드웨어로드 밸런서는 매우 비싸기 때문에 상당한 양의 유휴 자본이 발생한다.
* 최신 분산 시스템 설계는 활성 / 백업이 제공하는 것보다 더 높은 내결함성을 선호한다. 예를 들어, 최적의 시스템은 여러 번의 동시 장애가 발생하여 계속 작동 할 수 있어야 한다. 활성 및 백업로드 밸런서가 동시에 죽으면 HA로드 밸런서 쌍이 전체 장애에 취약하다.
* 공급 업체의 독점적 대형 하드웨어 장치는 비용이 매우 많이 들고 공급 업체가 고정되는 현상(락인)이 발생한다. 일반적으로 이러한 하드웨어 장치를 상용 컴퓨팅 서버를 사용하여 구축 된 수평 확장 가능 소프트웨어 솔루션으로 교체하는 것이 바람직하다.

### 분산 된 일관된 해싱으로 클러스터를 통한 내결함성 및 확장

![Figure 12](/images/posts/fiture12-l4-fault-tolerance-and-scaling-via-clustered-load-balancers-and-consistent.png)

이전 섹션에서는 HA 쌍을 통한 L4로드 밸런서 내결함성 및 해당 설계 고유의 문제점을 소개했다. 2000 년대 초반에서 중반에 걸쳐 대규모 인터넷 인프라는 그림 12와 같이 대규모 병렬 L4로드 밸런싱 시스템을 설계하고 배포하기 시작했다. 이러한 시스템의 목표는 다음과 같다.

* 이전 섹션에서 설명한 HA 쌍 디자인의 모든 단점을 완화.
* 공급 업체의 독점 하드웨어로드 밸런서에서 표준 컴퓨팅 서버 및 NIC를 사용하여 구축 된 상용 소프트웨어 솔루션으로 이동.

이 L4로드 밸런서 설계는 클러스터링 및 분산 된 일관된 해싱을 통한 내결함성 및 스케일링 이라고 한다. 작동원리는 다음과 같다.

* N 에지 라우터는 모든 Anycast VIP를 동일한 BGP 가중치로 본다. 동일 비용 다중 경로 라우팅 (ECMP)은 일반적으로 단일 흐름의 모든 패킷이 동일한 에지 라우터에 도착하도록 보장하는 데 사용한다. 흐름은 일반적으로 소스 IP / 포트 및 대상 IP / 포트의 4 튜플이다. 간단히 말해서, ECMP는 일관된 해싱을 사용하여 동일 가중치 네트워크 링크 세트를 통해 패킷을 분배하는 방법이다. 에지 라우터 자체는 어느 패킷이 어디로 도착하는지는 신경 쓰지 않지만, 일반적으로 흐름의 모든 패킷은 성능을 저하시키는 비 순차적 패킷을 피하기 위해 동일한 링크 세트를 통과하는 것이 바람직하다.
* N L4로드 밸런서 시스템은 모든 VIP를 동일한 BGP 가중치로 에지 라우터에 발표한다. ECMP를 다시 사용하면 에지 라우터는 일반적으로 흐름에 대해 동일한로드 밸런서 시스템을 선택한다.
* 각 L4로드 밸런서 시스템은 일반적으로 부분 연결 추적을 수행 한 다음 일관된 해싱을 사용하여 흐름에 대한 백엔드를 선택한다. GRE는로드 밸런서에서 백엔드로 전송 된 패킷을 캡슐화하는 데 사용된다.
* DSR을 사용하여 에지 라우터를 통해 백엔드에서 클라이언트로 직접 패킷을 보낸다.
* L4로드 밸런서에서 사용되는 실제 일관된 해싱 알고리즘은 활발한 연구가 이뤄지는 분야다. 로드 균등화, 대기 시간 최소화, 백엔드 변경 중 중단 최소화, 메모리 오버 헤드 최소화 등등 다양한 요소가 있지만 여기서는 다루지 않는다.

위의 디자인이 HA 페어 접근 방식의 모든 단점을 어떻게 완화하는지 살펴보자.

* 필요에 따라 새로운 에지 라우터 및 로드 밸런서 시스템을 추가 할 수 있다. 새로운 머신이 추가 될 때 가능한 한 영향을받는 플로우 수를 줄이기 위해 모든 계층에서 일관된 해싱이 사용된다.
* 충분한 버스트 마진과 내결함성을 유지하면서 시스템의 리소스 사용량을 원하는만큼 높게 실행할 수 있다.
* 에지 라우터와로드 밸런서는 이제 기존 하드웨어로드 밸런서보다 훨씬 적은 비용으로 상용 하드웨어를 사용하여 구축 할 수 있다 (자세한 내용은 아래 참조).

이 설계에 대해 일반적으로 묻는 질문 중 하나는 "엣지 라우터가 ECMP를 통해 백엔드와 직접 대화하지 않는 이유는? 로드 밸런서가 필요한 이유는?"이다. 그 이유는 주로 DoS 완화 및 백엔드 운영 용이성 때문이다. 로드 밸런서가 없으면 각 백엔드가 BGP에 참여해야 하며 롤링 배포를 수행하는 데 시간이 많이 소요된다.

모든 최신 L4로드 밸런싱 시스템은 이 설계 (또는 일부 변형)로 이동하고 있다. 가장 널리 알려진 두 가지 예는 Google의 Maglev와 Amazon의 Network Load Balancer (NLB)이다. 현재 이 설계를 구현하는 OSS로드 밸런서가 없지만, 2018 년에 OSS를 릴리스 할 계획이 있는 회사는 있습니다. 모던 L4로드 밸런서는 네트워킹 공간에 중요한 부분이기 때문에 이 릴리스가 매우 기대된다.


